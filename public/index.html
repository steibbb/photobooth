
<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PICA Photobooth â€” Instant Memories</title>
<meta name="description" content="PICA: modern, professional instant photobooth. Capture, filter, save, and share." />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
/* =========================
	 VARIABLES & RESET
	 ========================= */
:root{
	--primary: #FF6B6B;
	--secondary: #4ECDC4;
	--accent: #FFE66D;
	--dark: #2C3E50;
	--muted: #6c7a89;
	--bg: #F8F9FA;
	--radius: 12px;
	--glass: rgba(255,255,255,0.6);
	--shadow: 0 6px 24px rgba(0,0,0,0.12);
	--fw-heading: 'Bebas Neue', sans-serif;
	--fw-body: 'Poppins', sans-serif;
	--transition: 250ms cubic-bezier(.2,.9,.3,1);
}

/* minimal reset */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
	font-family:var(--fw-body);
	background:var(--bg);
	color:var(--dark);
	-webkit-font-smoothing:antialiased;
	-moz-osx-font-smoothing:grayscale;
	line-height:1.5;
	-webkit-tap-highlight-color:transparent;
}

/* container */
.container{max-width:1200px;margin:0 auto;padding:0 20px;}

/* utility */
.flex{display:flex}
.center{align-items:center;justify-content:center}
.row{display:flex;gap:12px;align-items:center}
.btn{
	display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:999px;border:2px solid transparent;
	font-weight:600;text-decoration:none;cursor:pointer;transition:all var(--transition);
}
.btn-primary{background:var(--primary);color:white;border-color:var(--primary)}
.btn-primary:hover{transform:translateY(-3px);box-shadow:var(--shadow)}
.btn-ghost{background:transparent;border:2px solid rgba(0,0,0,0.06);color:var(--dark)}
.btn-share{background:var(--secondary);color:white;border-color:var(--secondary)}
.btn-share:hover{transform:translateY(-3px);box-shadow:var(--shadow)}
.badge{background:var(--secondary);color:white;padding:6px 10px;border-radius:999px;font-weight:600}

/* loading spinner */
.spinner {
	display: none;
	width: 40px;
	height: 40px;
	border: 4px solid var(--muted);
	border-top: 4px solid var(--primary);
	border-radius: 50%;
	animation: spin 1s linear infinite;
}
@keyframes spin {
	0% { transform: rotate(0deg); }
	100% { transform: rotate(360deg); }
}

/* NAV / PROGRESS */
.header{
	position:sticky;top:0;z-index:1200;
	backdrop-filter:blur(6px);
	background:linear-gradient(to right, rgba(255,255,255,0.75), rgba(255,255,255,0.55));
	border-bottom:1px solid rgba(0,0,0,0.04);
}
.header-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;max-width:1400px;margin:0 auto}
.brand{display:flex;align-items:center;gap:12px;font-weight:700}
.brand .logo{
	width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--secondary));
	display:grid;place-items:center;color:white;font-family:var(--fw-heading);font-size:18px;box-shadow:var(--shadow)
}
.brand .name{font-family:var(--fw-heading);font-size:18px;color:var(--dark);letter-spacing:1px}
.nav {display:flex;gap:12px;align-items:center}
.progress-bar{height:4px;background:linear-gradient(90deg,var(--primary),var(--secondary));width:0;transition:width 120ms linear;border-radius:999px}

/* HERO */
.hero{min-height:72vh;display:grid;place-items:center;position:relative;overflow:hidden;background:
	radial-gradient(60% 60% at 10% 10%, rgba(255,255,255,0.05), transparent),
	linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));
	padding:60px 20px;}
.hero-card{background:linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.9));border-radius:18px;padding:36px;box-shadow:var(--shadow);text-align:center;max-width:980px}
.title{font-family:var(--fw-heading);font-size:64px;color:var(--primary);margin-bottom:6px;line-height:1}
.lead{font-size:18px;color:var(--muted);margin-bottom:18px;font-weight:300}

/* sections */
.section{padding:56px 0}
.section-title{font-family:var(--fw-heading);font-size:32px;color:var(--primary);text-align:center;margin-bottom:18px}

/* STATS GRID */
.grid-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:18px}
.stat-card{background:white;padding:18px;border-radius:12px;box-shadow:var(--shadow);text-align:center}
.stat-card h3{font-size:14px;color:var(--muted);font-weight:600;margin-bottom:6px}
.stat-number{font-family:var(--fw-heading);font-size:28px;color:var(--primary)}

/* CAMERA GRID */
.camera-grid{display:grid;gap:18px;grid-template-columns:1fr;align-items:start}
.camera-wrap{background:white;padding:18px;border-radius:12px;box-shadow:var(--shadow);display:flex;flex-direction:column;align-items:center;position:relative}
#webcam-feed{width:100%;max-width:420px;border-radius:12px;background:#000;transform:scaleX(-1);display:block}
#photo-canvas{display:none;border-radius:12px}
.controls{margin-top:12px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.capture-btn{
	width:84px;height:84px;border-radius:50%;display:grid;place-items:center;background:var(--primary);border:6px solid white;box-shadow:0 8px 30px rgba(0,0,0,0.12);cursor:pointer;transition:transform 120ms;
}
.capture-btn:active{transform:scale(0.96)}
.capture-btn:focus{outline:2px solid var(--accent);outline-offset:2px}
.countdown{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-family:var(--fw-heading);font-size:72px;color:var(--accent);text-shadow:3px 3px 0 rgba(0,0,0,0.12);pointer-events:none;opacity:0;transition:opacity 200ms}
.flash{position:absolute;inset:0;background:white;opacity:0;pointer-events:none;transition:opacity 200ms}

/* FILTERS */
.filter-group{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.filter-btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:white;cursor:pointer}
.filter-btn.active{background:var(--secondary);color:white;border-color:var(--secondary);font-weight:600;box-shadow:0 6px 16px rgba(78,205,196,0.12)}
.filter-btn:focus{outline:2px solid var(--accent);outline-offset:2px}

/* PREVIEW */
.preview{margin-top:12px;display:flex;flex-direction:column;gap:8px;align-items:center}
.preview img{max-width:320px;border-radius:10px;box-shadow:var(--shadow);loading:lazy}

/* GALLERY */
.gallery-controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px}
.gallery-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}
.gallery-item{position:relative;border-radius:12px;overflow:hidden;background:#eee}
.gallery-item img{display:block;width:100%;height:100%;object-fit:cover;transition:transform 300ms;loading:lazy}
.gallery-item:hover img{transform:scale(1.05)}
.download-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;opacity:0;background:linear-gradient(0deg, rgba(0,0,0,0.5), rgba(0,0,0,0.3));transition:opacity 200ms}
.gallery-item:hover .download-overlay{opacity:1}

/* LIGHTBOX */
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;z-index:1400}
.lightbox img{max-width:90%;max-height:90%;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.6);loading:lazy}

/* FOOTER */
.footer{background:var(--dark);color:white;padding:40px 0;border-top:1px solid rgba(255,255,255,0.04)}
.footer a{color:var(--accent);text-decoration:none}

/* MODALS & TOASTS */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:1300}
.modal-content{background:white;padding:20px;border-radius:12px;min-width:320px;max-width:720px;box-shadow:var(--shadow)}
.close{position:absolute;right:12px;top:12px;cursor:pointer;font-weight:700}

/* toast */
#toast-container{position:fixed;right:20px;bottom:20px;z-index:2000;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--dark);color:white;padding:12px 16px;border-radius:10px;box-shadow:var(--shadow);opacity:0;transform:translateX(16px);transition:all 260ms}
.toast.show{opacity:1;transform:translateX(0)}
.toast.success{background:var(--secondary)}
.toast.error{background:var(--primary)}
.toast.info{background:var(--dark)}

/* Feedback section specific tweaks */
.feedback-card{background:white;padding:18px;border-radius:12px;box-shadow:var(--shadow)}
.feedback-form .input, .feedback-form textarea, .feedback-controls select {width:100%;padding:10px;border-radius:8px;border:1px solid #eee}

/* Responsive */
@media(min-width:880px){
	.camera-grid{grid-template-columns:3fr 2fr}
	.title{font-size:96px}
}
@media(min-width:1200px){
	.container{max-width:1400px}
}
</style>
</head>
<body>
<header class="header" aria-hidden="false">
	<div class="header-inner container">
		<div class="brand" role="banner">
			<div class="logo" aria-hidden="true">P</div>
			<div>
				<div class="name">PICA</div>
				<div style="font-size:12px;color:var(--muted)">Instant Memories</div>
			</div>
		</div>

		<nav class="nav" aria-label="Main Navigation">
			<a href="#hero" class="btn btn-ghost">Home</a>
			<a href="#camera" class="btn btn-ghost">Booth</a>
			<a href="#gallery" class="btn btn-ghost">Gallery</a>
			<a href="#feedback" class="btn btn-ghost">Feedback</a>
			<a href="#contact" class="btn btn-ghost">Contact</a>
			<button id="theme-toggle" class="btn btn-ghost" title="Toggle theme" aria-label="Toggle theme">ðŸŒ“</button>
		</nav>
	</div>
	<div class="progress-bar" id="scroll-progress" aria-hidden="true"></div>
</header>

<section id="hero" class="hero">
	<div class="hero-card container" role="region" aria-label="Hero">
		<h1 class="title">PICA</h1>
		<p class="lead">Professional-quality photobooth experience â€” instant capture, signature filters, and a gallery that remembers.</p>
		<div class="row center">
			<a href="#camera" class="btn btn-primary" id="start-booth">Start Booth</a>
			<a href="#gallery" class="btn btn-ghost">View Gallery</a>
			<span class="badge">Events â€¢ Weddings â€¢ Parties</span>
		</div>
	</div>
</section>

<section class="section" id="dashboard">
	<div class="container">
		<h2 class="section-title">Dashboard & Stats</h2>
		<div class="grid-stats">
			<div class="stat-card"><h3>Total Photos</h3><div id="stat-total" class="stat-number">0</div></div>
			<div class="stat-card"><h3>Today's Captures</h3><div id="stat-today" class="stat-number">0</div></div>
			<div class="stat-card"><h3>Happy Clients</h3><div id="stat-clients" class="stat-number">98%</div></div>
		</div>
	</div>
</section>

<section class="section" id="camera" aria-label="Booth">
	<div class="container">
		<h2 class="section-title">The PICA Booth</h2>
		<div class="camera-grid">
			<div class="camera-wrap" aria-live="polite">
				<div class="spinner" id="camera-spinner"></div>
				<video id="webcam-feed" autoplay playsinline muted></video>
				<canvas id="photo-canvas" width="640" height="480"></canvas>
				<div id="countdown" class="countdown" aria-hidden="true">3</div>
				<div id="flash" class="flash" aria-hidden="true"></div>

				<div class="controls">
					<button id="capture-btn" class="capture-btn" aria-label="Capture photo" title="Capture (3-2-1)">
						<svg width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="5" fill="white"/></svg>
					</button>
					<button id="save-btn" class="btn btn-ghost" title="Download last preview">Download</button>
					<button id="share-btn" class="btn btn-share" title="Share last preview" disabled>Share</button>
					<button id="clear-gallery" class="btn btn-ghost" title="Clear local gallery">Clear Gallery</button>
				</div>

				<div class="preview" id="instant-preview" hidden>
					<h4 style="font-weight:600">Instant Preview</h4>
					<img id="preview-img" alt="Captured photo preview" loading="lazy">
				</div>
			</div>

			<aside class="camera-wrap" aria-label="Controls">
				<h3 style="margin-bottom:8px">Filters & Effects</h3>
				<div id="filter-options" class="filter-group" role="radiogroup"></div>

				<div style="margin-top:14px">
					<label for="countdown-select" style="font-size:13px;color:var(--muted)">Countdown:</label>
					<select id="countdown-select" style="margin-left:8px;padding:8px;border-radius:8px">
						<option value="0">Off</option>
						<option value="2">2s</option>
						<option value="3" selected>3s</option>
						<option value="5">5s</option>
					</select>
				</div>

				<div style="margin-top:16px">
					<h4 style="font-size:14px;color:var(--muted);margin-bottom:8px">Camera Status</h4>
					<div id="camera-status" style="font-size:14px;color:var(--muted)" aria-live="assertive">Initializing...</div>
				</div>
			</aside>
		</div>
	</div>
</section>

<section class="section" id="gallery">
	<div class="container">
		<h2 class="section-title">Gallery & Memories</h2>

		<div class="gallery-controls">
			<input id="gallery-search" type="search" placeholder="Search by date or id..." style="padding:10px;border-radius:10px;border:1px solid #ddd;min-width:220px" aria-label="Search gallery">
			<select id="gallery-filter" style="padding:10px;border-radius:10px;border:1px solid #ddd" aria-label="Filter gallery">
				<option value="all">All</option>
				<option value="local">Saved (Local)</option>
				<option value="placeholder">Placeholders</option>
			</select>
			<button id="upload-sim" class="btn btn-ghost">Simulate Upload</button>
		</div>

		<div id="gallery-grid" class="gallery-grid" aria-live="polite"></div>
	</div>
</section>

<section class="section" id="feedback" aria-label="User Feedback">
	<div class="container">
		<h2 class="section-title">User Feedback</h2>

		<div style="display:grid;gap:16px">
			<div class="feedback-card">
				<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
					<div>
						<h3 style="margin:0;font-weight:700">Send feedback</h3>
						<div style="font-size:13px;color:var(--muted)">We read everything â€” short feedback helps us improve.</div>
					</div>
					<div style="display:flex;gap:8px;align-items:center">
						<div id="userIdBadge" style="font-size:12px;color:var(--muted)"></div>
						<button id="exportCsvBtn" class="btn btn-ghost" type="button" title="Export visible feedbacks as CSV">Export CSV</button>
					</div>
				</div>

				<form id="feedbackForm" class="feedback-form" novalidate style="display:grid;gap:10px">
					<div>
						<label for="nameInput" style="font-size:13px;font-weight:600">Name</label>
						<input id="nameInput" name="name" type="text" placeholder="Your name (optional)" class="input" style="margin-top:6px">
					</div>
					<div>
						<label for="messageInput" style="font-size:13px;font-weight:600">Message</label>
						<textarea id="messageInput" name="message" rows="4" required placeholder="Write your feedback..." style="margin-top:6px"></textarea>
					</div>

					<div style="display:flex;gap:8px;align-items:center">
						<button id="submitButton" type="submit" class="btn btn-primary">Send</button>
						<button id="clearDraftBtn" type="button" class="btn btn-ghost">Clear Draft</button>
						<div id="autosaveStatus" aria-live="polite" style="font-size:13px;color:var(--muted)"></div>
					</div>
				</form>
			</div>

			<div class="feedback-card">
				<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
					<h3 style="margin:0;font-weight:700">Feedbacks</h3>
					<div style="display:flex;gap:8px;align-items:center">
						<input id="search" placeholder="Search messages or name" style="padding:8px;border-radius:8px;border:1px solid #eee" aria-label="Search feedback">
						<select id="sortSelect" style="padding:8px;border-radius:8px;border:1px solid #eee" aria-label="Sort feedback">
							<option value="newest">Newest</option>
							<option value="oldest">Oldest</option>
							<option value="name">Name Aâ€“Z</option>
						</select>
					</div>
				</div>

				<ul id="feedbackList" class="feedback-list" role="list" aria-live="polite" style="display:grid;gap:10px"></ul>
				<div id="emptyState" style="color:var(--muted);margin-top:10px">No feedback yet â€” be the first!</div>
			</div>
		</div>
	</div>
</section>

<section class="section" id="services">
	<div class="container">
		<h2 class="section-title">Our Packages</h2>
		<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
			<div class="stat-card">
				<h3>Weddings</h3>
				<p style="color:var(--muted)">All-day coverage, premium prints and digital delivery.</p>
			</div>
			<div class="stat-card">
				<h3>Corporate</h3>
				<p style="color:var(--muted)">Branded experiences and professional headshots.</p>
			</div>
			<div class="stat-card">
				<h3>Parties</h3>
				<p style="color:var(--muted)">Props, instant prints, and shareable galleries.</p>
			</div>
		</div>
	</div>
</section>

<footer class="footer" id="contact">
	<div class="container" style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
		<div>
			<h3 style="color:var(--accent);margin-bottom:8px">Get in touch</h3>
			<form id="contact-form" style="display:grid;gap:8px">
				<input name="name" placeholder="Your name" required style="padding:10px;border-radius:8px;border:1px solid #2222">
				<input name="email" placeholder="Your email" type="email" required style="padding:10px;border-radius:8px;border:1px solid #2222">
				<textarea name="message" placeholder="Message" required style="padding:10px;border-radius:8px;border:1px solid #2222;min-height:90px"></textarea>
				<button class="btn btn-primary" type="submit">Send Message</button>
			</form>
		</div>

		<div>
			<h3 style="color:var(--accent);margin-bottom:8px">Studio</h3>
			<p style="color:#ddd">PICA Photobooth â€¢ Sample Studio Address â€¢ Open for bookings</p>
			<p style="color:#ddd;margin-top:12px">Â© <span id="year"></span> PICA Photobooth</p>
		</div>
	</div>
</footer>

<div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-hidden="true" tabindex="-1">
	<button id="lightbox-close" class="btn btn-ghost" style="position:absolute;top:26px;right:26px" aria-label="Close lightbox">Close</button>
	<img id="lightbox-img" alt="Enlarged photo" loading="lazy">
</div>

<div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
	<div class="modal-content" role="document">
		<button id="modal-close" class="close" aria-label="Close modal">âœ•</button>
		<h3>Simulated Modal</h3>
		<p>This space can be used for login, upload, or booking flows.</p>
	</div>
</div>

<div id="confirmModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
	<div class="modal-content" role="document">
		<h3 id="confirmTitle" style="margin-top:0">Confirm delete</h3>
		<p style="color:var(--muted)">Are you sure you want to delete this feedback? This action can be undone with the Undo button shown after delete.</p>
		<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
			<button id="cancelDeleteBtn" class="btn btn-ghost">Cancel</button>
			<button id="confirmDeleteBtn" class="btn btn-primary">Delete</button>
		</div>
	</div>
</div>

<div id="toast-container" aria-live="polite" aria-atomic="true"></div>

<script>
/* =====================================================================================
	 JAVASCRIPT CORE (PICA site) + Integrated Feedback System
	 ===================================================================================== */

// ----------------- Shared DOM utilities & small helpers -----------------
const $ = id => document.getElementById(id);
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,7);
const debounce = (fn, t=300) => { let st; return (...a) => { clearTimeout(st); st = setTimeout(() => fn(...a), t); }; };
function isLocalStorageAvailable() {
	try { const test = '_storage_test_'; localStorage.setItem(test, test); localStorage.removeItem(test); return true; }
	catch(e) { return false; }
}
function sanitizeInput(str) {
	const div = document.createElement('div');
	div.textContent = str;
	return div.innerHTML;
}

// ----------------- PICA DOM refs ---------------------------------------
const DOM = {
	progress: $('scroll-progress'),
	video: $('webcam-feed'),
	canvas: $('photo-canvas'),
	ctx: $('photo-canvas') ? $('photo-canvas').getContext('2d') : null,
	captureBtn: $('capture-btn'),
	previewWrap: $('instant-preview'),
	previewImg: $('preview-img'),
	countdownEl: $('countdown'),
	flash: $('flash'),
	saveBtn: $('save-btn'),
	shareBtn: $('share-btn'),
	clearBtn: $('clear-gallery'),
	status: $('camera-status'),
	countdownSelect: $('countdown-select'),
	filterOptions: $('filter-options'),
	galleryGrid: $('gallery-grid'),
	gallerySearch: $('gallery-search'),
	galleryFilter: $('gallery-filter'),
	lightbox: $('lightbox'),
	lightboxImg: $('lightbox-img'),
	lightboxClose: $('lightbox-close'),
	toastContainer: $('toast-container'),
	themeToggle: $('theme-toggle'),
	year: $('year'),
	cameraSpinner: $('camera-spinner'),
};

// ----------------- GLOBAL TOAST function (extended) -----------------------
function showToast(msg, type='info', { actionText, action, timeout = 4500 } = {}) {
	const container = DOM.toastContainer;
	const t = document.createElement('div');
	t.className = 'toast ' + type;
	t.setAttribute('role', 'status');
	t.setAttribute('aria-live', 'polite');

	const inner = document.createElement('div');
	inner.style.display = 'flex';
	inner.style.alignItems = 'center';
	inner.style.justifyContent = 'space-between';
	inner.style.gap = '12px';

	const text = document.createElement('div');
	text.textContent = msg;
	inner.appendChild(text);

	if (actionText && action) {
		const btn = document.createElement('button');
		btn.className = 'btn btn-primary';
		btn.style.padding = '6px 10px';
		btn.style.borderRadius = '8px';
		btn.textContent = actionText;
		btn.setAttribute('aria-label', actionText);
		btn.addEventListener('click', () => { action(); remove(); });
		inner.appendChild(btn);
	}

	t.appendChild(inner);
	container.appendChild(t);

	requestAnimationFrame(() => t.classList.add('show'));

	let hideTimeout = null;
	function remove() {
		t.classList.remove('show');
		setTimeout(() => t.remove(), 260);
		if (hideTimeout) clearTimeout(hideTimeout);
	}
	if (timeout) hideTimeout = setTimeout(remove, timeout);

	return { hide: remove, element: t };
}

// ----------------- NAV/THEME/PROGRESS ------------------------------------
$('theme-toggle').addEventListener('click', () => {
	document.documentElement.classList.toggle('dark-mode');
	showToast('Theme toggled', 'success');
});
window.addEventListener('scroll', () => {
	const top = window.scrollY, h = document.documentElement.scrollHeight - window.innerHeight;
	const pct = Math.min(100, Math.round((top/h)*100));
	DOM.progress.style.width = pct + '%';
});

// ----------------- INTERSECTION ANIMATIONS -------------------------------
const io = new IntersectionObserver((entries) => {
	entries.forEach(e => {
		if (e.isIntersecting) {
			e.target.style.transition = 'opacity 600ms ease, transform 600ms ease';
			e.target.style.opacity = 1;
			e.target.style.transform = 'translateY(0)';
		}
	});
}, { threshold: 0.18 });
document.querySelectorAll('.section-title, .camera-wrap, .stat-card, .hero-card').forEach(el => {
	el.style.opacity = 0;
	el.style.transform = 'translateY(12px)';
	io.observe(el);
});

/* ========================= CAMERA + GALLERY ========================= */
const camera = {
	stream: null,
	filters: [
		{name: 'None', filter: 'none'},
		{name: 'B&W', filter: 'grayscale(100%)'},
		{name: 'Vintage', filter: 'sepia(80%) hue-rotate(10deg)'},
		{name: 'Color Pop', filter: 'saturate(160%) contrast(110%)'},
		{name: 'Cool', filter: 'hue-rotate(200deg) saturate(120%)'},
		{name: 'Polaroid', filter: 'polaroid'}
	],
	currentFilter: 'none'
};

async function initCamera() {
	DOM.cameraSpinner.style.display = 'block';
	DOM.video.style.display = 'none';
	try {
		const p = { video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'user' }, audio: false };
		camera.stream = await navigator.mediaDevices.getUserMedia(p);
		DOM.video.srcObject = camera.stream;
		DOM.video.onloadedmetadata = () => {
			DOM.video.play();
			DOM.cameraSpinner.style.display = 'none';
			DOM.video.style.display = 'block';
		};
		DOM.status.textContent = 'Camera ready â€” choose a filter and smile!';
		showToast('Camera initialized', 'success');
	} catch (err) {
		console.error(err);
		DOM.cameraSpinner.style.display = 'none';
		DOM.status.textContent = 'Cannot access camera â€” please grant permission or use a supported browser.';
		showToast('Webcam access required!', 'error');
	}
}

function renderFilters() {
	DOM.filterOptions.innerHTML = '';
	camera.filters.forEach((f, i) => {
		const btn = document.createElement('button');
		btn.className = 'filter-btn';
		btn.textContent = f.name;
		btn.setAttribute('aria-checked', 'false');
		btn.setAttribute('role', 'radio');
		btn.addEventListener('click', () => {
			document.querySelectorAll('.filter-btn').forEach(b => {
				b.classList.remove('active');
				b.setAttribute('aria-checked', 'false');
			});
			btn.classList.add('active');
			btn.setAttribute('aria-checked', 'true');
			camera.currentFilter = f.filter;
			DOM.video.style.filter = f.filter === 'polaroid' ? 'none' : f.filter;
			DOM.status.textContent = 'Filter: ' + f.name;
		});
		if (i === 0) {
			btn.classList.add('active');
			btn.setAttribute('aria-checked', 'true');
		}
		DOM.filterOptions.appendChild(btn);
	});
}

function flashAnimation() {
	DOM.flash.style.opacity = 1;
	setTimeout(() => DOM.flash.style.opacity = 0, 160);
}

function countdownAndCapture() {
	if (!camera.stream) { showToast('Camera not ready', 'error'); return; }
	const seconds = parseInt(DOM.countdownSelect.value) || 0;
	if (seconds <= 0) { capturePhoto(); return; }
	let count = seconds;
	DOM.captureBtn.disabled = true;
	DOM.countdownEl.textContent = count;
	DOM.countdownEl.style.opacity = 1;
	DOM.status.textContent = 'Capturing in ' + count + '...';
	const id = setInterval(() => {
	count--;
	DOM.status.textContent = count > 0 ? 'Capturing in ' + count + '...' : 'Snap!';
	DOM.countdownEl.textContent = count > 0 ? count : 'FLASH!';
		if (count <= 0) {
			clearInterval(id);
			setTimeout(() => {
				DOM.countdownEl.style.opacity = 0;
				capturePhoto();
				DOM.captureBtn.disabled = false;
				DOM.status.textContent = 'Photo captured & saved locally.';
			}, 350);
		}
	}, 1000);
}

function capturePhoto() {
	const v = DOM.video;
	const c = DOM.canvas;
	const ctx = DOM.ctx;
	if (!c || !ctx) return;
	c.width = v.videoWidth || 640;
	c.height = v.videoHeight || 480;
	ctx.save();
	if (camera.currentFilter === 'polaroid') {
		const w = c.width;
		const h = c.height;
		const margin = w * 0.03;
		const bottomHeight = h * 0.20;
		const photoHeight = h - margin - bottomHeight;
		const photoWidth = w - (2 * margin);
		ctx.fillStyle = 'white';
		ctx.fillRect(0, 0, w, h);
		ctx.scale(-1, 1);
		ctx.translate(-w, 0);
		ctx.drawImage(v, 0, 0, v.videoWidth, v.videoHeight, margin, margin, photoWidth, photoHeight);
	ctx.restore();
	ctx.font = 'bold ' + (h * 0.04) + 'px ' + (document.body.style.fontFamily || 'sans-serif');
		ctx.fillStyle = '#2C3E50';
		ctx.textAlign = 'center';
		const dateText = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
		ctx.fillText(dateText, w / 2, h - (bottomHeight / 2) + (h * 0.015));
	} else {
		ctx.filter = camera.currentFilter;
		ctx.scale(-1, 1);
		ctx.translate(-c.width, 0);
		ctx.drawImage(v, 0, 0, c.width, c.height);
		ctx.restore();
	}
	flashAnimation();
	try {
		const ac = new (window.AudioContext || window.webkitAudioContext)();
		const o = ac.createOscillator();
		const g = ac.createGain();
		o.type = 'triangle';
		o.frequency.value = 700;
		g.gain.value = 0.001;
		o.connect(g);
		g.connect(ac.destination);
		o.start();
		setTimeout(() => { o.stop(); ac.close(); }, 90);
	} catch (e) {}
	const dataUrl = c.toDataURL('image/png');
	DOM.previewImg.src = dataUrl;
	DOM.previewWrap.hidden = false;
	DOM.shareBtn.disabled = false;
	savePhoto({ id: uid(), data: dataUrl, created: new Date().toISOString(), srcType: 'local', filter: camera.currentFilter });
	refreshGallery();
	updateStats();
}

DOM.saveBtn.addEventListener('click', () => {
	if (!DOM.previewImg.src || DOM.previewWrap.hidden) {
		showToast('No preview available. Capture a photo first.', 'info');
		return;
	}
	const a = document.createElement('a');
	a.href = DOM.previewImg.src;
	a.download = 'PICA_' + Date.now() + '.png';
	document.body.appendChild(a);
	a.click();
	a.remove();
	showToast('Preview downloaded', 'success');
});

DOM.shareBtn.addEventListener('click', async () => {
	if (!DOM.previewImg.src || DOM.previewWrap.hidden) {
		showToast('No preview available. Capture a photo first.', 'info');
		return;
	}
	try {
	const response = await fetch(DOM.previewImg.src);
	const blob = await response.blob();
	const file = new File([blob], 'PICA_' + Date.now() + '.png', { type: 'image/png' });
		if (navigator.share) {
			await navigator.share({
				files: [file],
				title: 'PICA Photobooth',
				text: 'Check out my photo from PICA Photobooth!'
			});
			showToast('Photo shared', 'success');
		} else {
			showToast('Sharing not supported on this device', 'error');
		}
	} catch (err) {
		console.error(err);
		showToast('Error sharing photo', 'error');
	}
});

DOM.clearBtn.addEventListener('click', () => {
	if (!isLocalStorageAvailable()) {
		showToast('Local storage is not available.', 'error');
		return;
	}
	if (confirm('Clear saved gallery? This removes only local saved photos.')) {
		localStorage.removeItem('pica_photos');
		showToast('Local gallery cleared', 'success');
		refreshGallery();
		updateStats();
	}
});

function loadSaved() {
	if (!isLocalStorageAvailable()) return [];
	try {
		const raw = localStorage.getItem('pica_photos');
		return raw ? JSON.parse(raw) : [];
	} catch (e) {
		console.error(e);
		return [];
	}
}

function savePhoto(photo) {
	if (!isLocalStorageAvailable()) {
		showToast('Local storage is disabled. Photo not saved.', 'error');
		return;
	}
	const photos = loadSaved();
	photos.unshift(photo);
	if (photos.length > 500) photos.splice(500);
	localStorage.setItem('pica_photos', JSON.stringify(photos));
}

function generatePlaceholder(index) {
	const colors = ['FF6B6B', '4ECDC4', 'FFE66D', 'A78BFA'];
	const c = colors[index % colors.length];
	const h = 260 + (index % 4) * 40;
	return {
		id: 'ph_' + index,
		data: `https://via.placeholder.com/480x${h}/${c}/2C3E50?text=PICA+${index}`,
		created: new Date().toISOString(),
		srcType: 'placeholder'
	};
}

const G_PLACEHOLDER_COUNT = 48;
function refreshGallery() {
	const saved = loadSaved();
	const filter = DOM.galleryFilter.value;
	const q = (DOM.gallerySearch.value || '').trim().toLowerCase();
	let items = [];
	if (filter === 'all' || filter === 'local') items = items.concat(saved);
	if (filter === 'all' || filter === 'placeholder') {
		for (let i = 1; i <= G_PLACEHOLDER_COUNT; i++) items.push(generatePlaceholder(i));
	}
	if (q) {
		items = items.filter(it => {
			return (it.id && it.id.toLowerCase().includes(q)) ||
						 (it.created && it.created.toLowerCase().includes(q)) ||
						 (it.filter && it.filter.toLowerCase().includes(q));
		});
	}
	renderGalleryGrid(items);
}

function renderGalleryGrid(items) {
	DOM.galleryGrid.innerHTML = '';
	if (!items.length) {
		DOM.galleryGrid.innerHTML = '<div style="padding:20px;color:var(--muted)">No photos found</div>';
		return;
	}
	items.forEach(item => {
		const div = document.createElement('div');
		div.className = 'gallery-item';
		const img = document.createElement('img');
		img.loading = 'lazy';
		img.alt = 'PICA photo';
		img.src = item.data;
		img.dataset.id = item.id;
		img.addEventListener('click', () => openLightbox(item.data));
		div.appendChild(img);
		const overlay = document.createElement('div');
		overlay.className = 'download-overlay';
		const dl = document.createElement('button');
		dl.className = 'btn btn-primary';
		dl.textContent = 'Download';
		dl.setAttribute('aria-label', 'Download photo');
		dl.addEventListener('click', (ev) => {
			ev.stopPropagation();
			downloadUrl(item.data);
		});
		overlay.appendChild(dl);
		div.appendChild(overlay);
		DOM.galleryGrid.appendChild(div);
	});
}

function openLightbox(src) {
	DOM.lightboxImg.src = src;
	DOM.lightbox.style.display = 'flex';
	DOM.lightbox.setAttribute('aria-hidden', 'false');
	DOM.lightbox.focus();
}

DOM.lightboxClose.addEventListener('click', closeLightbox);
DOM.lightbox.addEventListener('click', (e) => {
	if (e.target === DOM.lightbox) closeLightbox();
});
document.addEventListener('keydown', (e) => {
	if (e.key === 'Escape') closeLightbox();
});

function closeLightbox() {
	DOM.lightbox.style.display = 'none';
	DOM.lightbox.setAttribute('aria-hidden', 'true');
}

function downloadUrl(url) {
	const a = document.createElement('a');
	a.href = url;
	a.download = `PICA_${Date.now()}.png`;
	document.body.appendChild(a);
	a.click();
	a.remove();
	showToast('Download started', 'success');
}

DOM.gallerySearch.addEventListener('input', debounce(() => refreshGallery(), 250));
DOM.galleryFilter.addEventListener('change', () => refreshGallery());
document.getElementById('upload-sim').addEventListener('click', () => {
	if (!isLocalStorageAvailable()) {
		showToast('Local storage is disabled. Cannot simulate upload.', 'error');
		return;
	}
	const ph = generatePlaceholder(Math.floor(Math.random() * 999));
	ph.id = 'uploaded_' + uid();
	ph.srcType = 'local';
	savePhoto(ph);
	refreshGallery();
	updateStats();
	showToast('Simulated upload saved to local gallery.', 'success');
});

function updateStats() {
	const saved = loadSaved();
	document.getElementById('stat-total').textContent = saved.length.toLocaleString();
	const today = saved.filter(s => {
		try {
			return s.srcType === 'local' && new Date(s.created).toDateString() === new Date().toDateString();
		} catch (e) {
			return false;
		}
	}).length;
	document.getElementById('stat-today').textContent = today;
}

/* --- contact form in footer --- */
document.getElementById('contact-form').addEventListener('submit', function(e) {
	e.preventDefault();
	const email = this.email ? this.email.value : (this.querySelector('input[type="email"]') ? this.querySelector('input[type="email"]').value : '');
	if (!email.includes('@')) {
		showToast('Please provide a valid email', 'error');
		return;
	}
	const btn = this.querySelector('button');
	if (btn) btn.textContent = 'Sending...';
	setTimeout(() => {
		this.reset();
		if (btn) btn.textContent = 'Send Message';
		showToast('Message sent â€” we will be in touch!', 'success');
	}, 1200);
});

/* ========================= FEEDBACK MODULE ========================= */
(function feedbackModule() {
	const STORAGE_KEY = 'pica.feedback.v1';
	const form = $('feedbackForm');
	const nameInput = $('nameInput');
	const messageInput = $('messageInput');
	const submitButton = $('submitButton');
	const clearDraftBtn = $('clearDraftBtn');
	const feedbackList = $('feedbackList');
	const emptyState = $('emptyState');
	const searchEl = $('search');
	const sortSelect = $('sortSelect');
	const exportCsvBtn = $('exportCsvBtn');
	const autosaveStatus = $('autosaveStatus');
	const userIdBadge = $('userIdBadge');
	const confirmModal = $('confirmModal');
	const confirmDeleteBtn = $('confirmDeleteBtn');
	const cancelDeleteBtn = $('cancelDeleteBtn');

	const uidBadge = uid().slice(0,6);
	if (userIdBadge) userIdBadge.textContent = 'id:' + uidBadge;

	function safeParse(raw) {
		try { return JSON.parse(raw); } catch (e) { return null; }
	}
	function nowISO() {
		return new Date().toISOString();
	}
	function csvEscape(value) {
		if (value === null || value === undefined) return '""';
		const s = String(value).replace(/"/g, '""');
		return '"' + s + '"';
	}

	function loadFromStorage() {
		const raw = localStorage.getItem(STORAGE_KEY);
		if (!raw) return [];
		const parsed = safeParse(raw);
		if (!Array.isArray(parsed)) return [];
		return parsed.map(item => ({
			id: item.id || uid(),
			name: sanitizeInput(item.name || ''),
			message: sanitizeInput(item.message || ''),
			createdAt: item.createdAt || item.updatedAt || nowISO(),
			updatedAt: item.updatedAt || null
		}));
	}
	function saveToStorage(arr) {
		localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
	}

	let feedbacks = loadFromStorage();
	let filtered = feedbacks.slice();
	let lastDeleted = null;
	let editingId = null;
	let pendingDeleteId = null;

	function formatDate(iso) {
		try { return new Date(iso).toLocaleString(); } catch (e) { return iso; }
	}

	function renderList(items) {
		feedbackList.innerHTML = '';
		if (!items || items.length === 0) {
			emptyState.style.display = 'block';
			return;
		}
		emptyState.style.display = 'none';
		const frag = document.createDocumentFragment();
		items.forEach(item => {
			const li = document.createElement('li');
			li.className = 'p-3 rounded border bg-white';
			li.style.padding = '12px';
			li.style.border = '1px solid #f0f0f0';
			li.setAttribute('data-id', item.id);

			const top = document.createElement('div');
			top.style.display = 'flex';
			top.style.justifyContent = 'space-between';
			top.style.alignItems = 'flex-start';
			const meta = document.createElement('div');
			const name = document.createElement('div');
			name.style.fontWeight = '600';
			name.textContent = item.name || 'Anonymous';
			const when = document.createElement('div');
			when.style.fontSize = '12px';
			when.style.color = 'var(--muted)';
			when.textContent = formatDate(item.createdAt);
			meta.appendChild(name);
			meta.appendChild(when);

			const actions = document.createElement('div');
			actions.style.display = 'flex';
			actions.style.gap = '8px';
			const editBtn = document.createElement('button');
			editBtn.className = 'btn btn-ghost';
			editBtn.style.padding = '6px 8px';
			editBtn.textContent = 'Edit';
			editBtn.setAttribute('aria-label', `Edit feedback from ${item.name || 'Anonymous'}`);
			editBtn.addEventListener('click', () => startEdit(item.id));
			const delBtn = document.createElement('button');
			delBtn.className = 'btn btn-ghost';
			delBtn.style.padding = '6px 8px';
			delBtn.textContent = 'Delete';
			delBtn.setAttribute('aria-label', `Delete feedback from ${item.name || 'Anonymous'}`);
			delBtn.addEventListener('click', () => askDelete(item.id));
			actions.appendChild(editBtn);
			actions.appendChild(delBtn);

			top.appendChild(meta);
			top.appendChild(actions);

			const msg = document.createElement('div');
			msg.style.whiteSpace = 'pre-wrap';
			msg.style.marginTop = '8px';
			msg.textContent = item.message;

			li.appendChild(top);
			li.appendChild(msg);
			frag.appendChild(li);
		});
		feedbackList.appendChild(frag);
	}

	function applyFiltersAndSort() {
		const q = (searchEl.value || '').trim().toLowerCase();
		const s = sortSelect.value;
		let list = feedbacks.slice();
		if (q) list = list.filter(i => (i.name || '').toLowerCase().includes(q) || (i.message || '').toLowerCase().includes(q));
		if (s === 'newest') list.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
		else if (s === 'oldest') list.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
		else if (s === 'name') list.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
		filtered = list;
		renderList(filtered);
	}

	function startEdit(id) {
		const item = feedbacks.find(f => f.id === id);
		if (!item) return;
		editingId = id;
		nameInput.value = item.name;
		messageInput.value = item.message;
		messageInput.focus();
		submitButton.textContent = 'Update';
	}

	function clearForm() {
		editingId = null;
		nameInput.value = '';
		messageInput.value = '';
		submitButton.textContent = 'Send';
	}

	function submitHandler(e) {
		e.preventDefault();
		const name = sanitizeInput((nameInput.value || '').trim());
		const message = sanitizeInput((messageInput.value || '').trim());
		if (!message) {
			messageInput.focus();
			showToast('Please enter a message', 'error');
			return;
		}
		if (editingId) {
			const idx = feedbacks.findIndex(f => f.id === editingId);
			if (idx >= 0) {
				feedbacks[idx] = { ...feedbacks[idx], name, message, updatedAt: nowISO() };
				saveToStorage(feedbacks);
				applyFiltersAndSort();
				showToast('Feedback updated', 'success');
				clearForm();
			}
		} else {
			const item = { id: uid(), name, message, createdAt: nowISO(), updatedAt: null };
			feedbacks.unshift(item);
			saveToStorage(feedbacks);
			applyFiltersAndSort();
			showToast('Feedback saved', 'success');
			clearForm();
		}
	}

	const draftKey = 'pica.feedback.draft.v1';
	const saveDraft = debounce(() => {
		const data = { name: nameInput.value, message: messageInput.value, at: nowISO() };
		localStorage.setItem(draftKey, JSON.stringify(data));
		autosaveStatus.textContent = 'Draft autosaved';
		setTimeout(() => autosaveStatus.textContent = '', 1200);
	}, 500);

	function loadDraft() {
		const raw = localStorage.getItem(draftKey);
		if (!raw) return;
		const d = safeParse(raw);
		if (!d) return;
		nameInput.value = sanitizeInput(d.name || '');
		messageInput.value = sanitizeInput(d.message || '');
		if (d.message) {
			autosaveStatus.textContent = 'Loaded draft';
			setTimeout(() => autosaveStatus.textContent = '', 1200);
		}
	}

	clearDraftBtn.addEventListener('click', () => {
		localStorage.removeItem(draftKey);
		clearForm();
		showToast('Draft cleared', 'success');
	});

	function askDelete(id) {
		pendingDeleteId = id;
		openModal();
	}

	function confirmDelete() {
		if (!pendingDeleteId) return closeModal();
		const idx = feedbacks.findIndex(f => f.id === pendingDeleteId);
		if (idx < 0) { closeModal(); return; }
		lastDeleted = feedbacks.splice(idx, 1)[0];
		saveToStorage(feedbacks);
		applyFiltersAndSort();
		closeModal();
		showToast('Feedback deleted', 'info', { actionText: 'Undo', action: undoDelete, timeout: 7000 });
	}

	function undoDelete() {
		if (!lastDeleted) return;
		feedbacks.unshift(lastDeleted);
		saveToStorage(feedbacks);
		applyFiltersAndSort();
		lastDeleted = null;
		showToast('Undo successful', 'success');
	}

	function openModal() {
		if (!confirmModal) return;
		confirmModal.style.display = 'flex';
		confirmModal.setAttribute('aria-hidden', 'false');
		cancelDeleteBtn.focus();
		function trap(e) {
			if (e.key === 'Escape') closeModal();
		}
		confirmModal._trap = trap;
		document.addEventListener('keydown', trap);
	}

	function closeModal() {
		if (!confirmModal) return;
		confirmModal.style.display = 'none';
		confirmModal.setAttribute('aria-hidden', 'true');
		if (confirmModal._trap) {
			document.removeEventListener('keydown', confirmModal._trap);
			confirmModal._trap = null;
		}
		pendingDeleteId = null;
	}

	confirmDeleteBtn.addEventListener('click', confirmDelete);
	cancelDeleteBtn.addEventListener('click', closeModal);

	function exportCSV() {
		const rows = filtered.length ? filtered : feedbacks;
		const header = ['id', 'name', 'message', 'createdAt', 'updatedAt'].map(csvEscape).join(',');
		const lines = [header];
		for (const r of rows) {
			lines.push([r.id, r.name, r.message, r.createdAt, r.updatedAt].map(csvEscape).join(','));
		}
		const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url;
		a.download = 'pica_feedbacks.csv';
		document.body.appendChild(a);
		a.click();
		a.remove();
		URL.revokeObjectURL(url);
		showToast('CSV exported', 'success');
	}
	exportCsvBtn.addEventListener('click', exportCSV);

	form.addEventListener('submit', submitHandler);
	nameInput.addEventListener('input', saveDraft);
	messageInput.addEventListener('input', saveDraft);
	searchEl.addEventListener('input', debounce(applyFiltersAndSort, 250));
	sortSelect.addEventListener('change', applyFiltersAndSort);

	loadDraft();
	applyFiltersAndSort();

	if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') window._picaFeedback = { feedbacks };
})();

// ----------------- INITIALIZATION ---------------------------------------
async function init() {
	if (DOM.year) DOM.year.textContent = new Date().getFullYear();
	renderFilters();
	await initCamera();
	refreshGallery();
	updateStats();
}
DOM.captureBtn.addEventListener('click', () => {
	const activeBtn = DOM.filterOptions.querySelector('.filter-btn.active');
	camera.currentFilter = activeBtn ? activeBtn.textContent : 'none';
	countdownAndCapture();
});
document.addEventListener('keydown', (e) => {
	if (e.code === 'Space' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
		e.preventDefault();
		DOM.captureBtn.click();
	}
});
init();
</script>
</body>
</html>
